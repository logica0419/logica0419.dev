---
title: "サークルの合宿に合わせてオリジナルISUCONを作った話"
emoji: "🪑"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["ISUCON"]
published: false
---
2023年も2カ月ほど過ぎましたが、皆様いかがお過ごしでしょうか？
ISUCON大好き、logicaです。

自分はISUCON12の前から「ISUCONの作問がしたい！」と豪語している希少な人間で、運営の皆さんからISUCONの問題が作れる技量を証明するのが早いよ、とアドバイスをいただいていました。
ISUCON12本選生放送の話の流れで、ISUCON作問のレジェンドとも言える[catatsuy](https://twitter.com/catatsuy)さんに弟子入り(？)もさせてもらってて、何でも言ってみるもんだなぁと思います。
https://twitter.com/catatsuy/status/1563464118409261056?s=20&t=pKdveurtZUiygSnW5DfdUA

で、かねてから作りたいと思っていたけど作る時間がどこにもなかったオリジナルISUCONを、大学生の特権である春休みを存分に生かして作ってみたので、ご紹介します。
https://github.com/logica0419/gasshuku-isucon

この記事では主に自分がどのようなことを考えて、どんなスケジュールで進めていったのかを綴っていきます。いわゆる開発日記ってやつです。

問題についてはこちらの記事にまとめています。
https://zenn.dev/logica0419/articles/gasshuku-isucon-problem
ベンチマーカーについてはこちらの記事にまとめています。
https://zenn.dev/logica0419/articles/gasshuku-isucon-benchmarker
ポータルについてはこちらの記事にまとめています。
https://zenn.dev/logica0419/articles/gasshuku-isucon-portal
ご興味あればこれらも是非ご覧下さい。

# 構想期

僕が所属するサークルのtraPでは、今年度に入ってからようやく合宿を開催できるようになりました。
今年の2月にも春合宿が開催されたのですが、それに対して1月ごろから「これに合わせて何かイベントができないか」と考え始めました。
そうして僕と同じくWeb系の活動をしている仲間内で話している時に、「ISUCON現地で開催したら面白いんじゃね？」という会話が生まれたのが始まりです。

テーマを何にするかは最も長い時間を費やして練りました。
様々なタイプのWebサービスを候補に上げましたが、dependabotのPRの整理をしていた時に「ライブラリ」から図書館の蔵書管理サービスに思い至りました。
ちょうど大学の図書館を入学して以来初めて使ったタイミングでもあったので、とても良いテーマが見つかったと思います。

ざっくりとした構想は1月中にちまちま練っていましたが、具体的にサービスの全容が頭の中で固まったのは2月の1週目でした。
この週にあった飲み会で終電近くの電車で乗換駅を数駅寝過ごして、結局泣く泣く最寄りまで5駅くらい歩いて帰ったという出来事がありまして、道すがらひたすらサービスを頭の中で構築し、ユーザーの要望をシミュレートしていました。
2時間の間にサービスの機能、データベースのテーブル設計がある程度固まりました。

サービスの概要は別記事でガッツリ解説してるので、是非そちらもご覧ください。
https://zenn.dev/logica0419/articles/gasshuku-isucon-problem#%E5%95%8F%E9%A1%8C%E6%A6%82%E8%A6%81

# サービス作成期

## QRコードの生成と検証

ひとまず、正当性の検証が地獄になる事が目に見えているQRコードの生成から進めました。
CLIを使う方法とライブラリを使う方法を同時に書き進めることで、想定解の正当性の検証を併せて進めていきました。

検証に関して、なんとか画像の一致で検証できないかと考えていましたが、CLIとライブラリから同じ設定で生成したQRコードの画像を比較しても体感3～4割違う画像が生成されてしまいました。
また上記の現象が起こるとき、違う画像が出力されているのに読み取ると全く同じ値が出てくるという状況に頭を抱えていました。
検証方法に非常に悩まされましたが、結局ベンチマーカー側でQRコードを読み取るという一番泥臭い方法に決まりました。

## ドメイン・スキーマ定義

次にドメインとなる構造体の定義とDBスキーマの設計を開始しました。
大体は構想期にできていたのでスムーズに進みましたが、インサートするデータを自動生成するため、ランダムな文字列を入れて問題なさそうなカラムを作ることを徹底しました。

また、ひとまずテーブルを作ってから`mysqldump`で書き出すことでスキーマの初期化SQLを作成したのですが、普段SQLを生で書くことが少なすぎて、最初のテーブル作成時に10分くらいコンマを付ける場所のエラーで詰まりました。
お恥ずかしい。

初めは複数の図書館の会員・蔵書を1つの大サーバーが管理するような構成を想定し、`library`テーブルに複数の図書館レコードを持っていました。
これを使って図書館同士の本の移譲等の機能も検討していたのですが、この時点でちょっと問題が重くなりすぎるなと感じました。
今回の問題はISUCON11事前学習と予選の中間くらいの難易度にしたいと思っていたので、1つの図書館のみで運用するサービスだと仮定し、`library`テーブルは削除することに決めました。

## ハンドラーの実装

ここまで来たら後はハンドラーを実装するだけです。
以下の順で実装を進めました。

### 初期化API

- `POST /initialize`

finalizeも入れるかどうか悩みましたが、よく考えた末、必要性を確実なものにできなかったため入れませんでした。

### 会員API

- `GET /members`
- `GET /members/:id`
- `POST /members`
- `GET /members/:id/qrcode`
- `PATCH /members/:id`
- `DELETE /members/:id`

会員のBANの表現に悩みましたが、`DELETE`メソッドで表すことにしました。
IDを指定するエンドポイントは、IDが暗号化されていてもされていなくても1つのエンドポイントで済むよう、IDの取得の部分は検討を重ねました。また、ユースケースをよく考え必要のない復号化はしないよう努めました。

### 蔵書API

- `GET /books/:id`
- `POST /books`
- `GET /books/:id/qrcode`
- `GET /books`

検索(`GET /books`)が一番面倒くさそうな匂いがしたので一番後回しになりました。予想通りクエリを組むのがだるかったですね。
文字列の置き換えを使ったクエリのすり替えまで行っており、頭の中でちゃんと組み立ててあげないと理解できないようになっていたと思います。

蔵書情報の取得系APIには、あえてボトルネックを作るために、その本が貸し出されているかどうかを同時に返すよう設計しました。

### 貸出API

- `GET /lendings`
- `POST /lendings`
- `POST /lendings/return`

本来`POST /lendings/return`は、この形に鳴るまでに紆余曲折ありました。
最初`DELETE /lendings/:id`として実装していましたが、まずユースケースを考えた時IDではなくMemberIDとBookIDの組み合わせでしか設定できないことに気づき、`DELETE /lendings`に変更しました。
その後、`DELETE`メソッドのリクエストボディは RFC 9110 (2022年6月) にて利用できないことが明記された事を知り、`POST`メソッドに変更して今の形になっているという次第です。

3つのエンドポイントそれぞれにN+1問題が仕込まれており、なおかつ全て解決方法が異なるという中々厄介なエンドポイント群になっていたかと思います。

# ベンチマーカー作成期

ベンチマーカーの実装は、普段からやっている実装ではなかったので非常に苦労しました。
とりあえず学習としてISUCON本の付録Bを読んで、ベンチマーカーが何を必要としているのかとisucandarが何を抽象化しているのか理解しました。とりあえずベンチ作りたい人は読んどいたほうがいい。絶対。
https://gihyo.jp/book/2022/978-4-297-12846-3

その後、ディレクトリ構造が1層になっていて非常に美しい実装になっていると感じたisucon11-priorとisucon12-qualifierのベンチマークを読み漁り、ベンチマーカーの実装を頭に思い浮かべました。
https://github.com/isucon/isucon11-prior
https://github.com/isucon/isucon12-qualify
やはりrozyさんとfujiwara組のみなさんのベンチマーカー実装への慣れはすごいと感じました。ディレクトリ1層なのに非常に綺麗に書かれていて、むしろディレクトリ構造をしっかり組んだ方が悪なのではないかと思わされました。
ただ、たとえ悪手だとしても一度はしっかりとしたディレクトリ構造をしたベンチマーカーに挑戦してみたいと思い、階層構造を設けることに決めました。
