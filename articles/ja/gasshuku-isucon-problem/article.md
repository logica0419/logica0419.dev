---
title: "gasshuku-isuconの問題を解説する"
emoji: "🪑"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ISUCON"]
published: false
---
2023年も2カ月ほど過ぎましたが、皆様いかがお過ごしでしょうか？
ISUCON大好き、logicaです。

自分はISUCON12の前から「ISUCONの作問がしたい！」と豪語している希少な人間で、運営の皆さんからISUCONの問題が作れる技量を証明するのが早いよ、とアドバイスをいただいていました。
ISUCON12本選生放送の話の流れで、ISUCON作問のレジェンドとも言える[catatsuy](https://twitter.com/catatsuy)さんに弟子入り(？)もさせてもらってて、何でも言ってみるもんだなぁと思います。
https://twitter.com/catatsuy/status/1563464118409261056?s=20&t=pKdveurtZUiygSnW5DfdUA

で、かねてから作りたいと思っていたけど作る時間がどこにもなかったオリジナルISUCONを、大学生の特権である春休みを存分に生かして作ってみたので、ご紹介します。
https://github.com/logica0419/gasshuku-isucon

この記事では問題について解説していきます。

ベンチマーカーについてはこちらの記事にまとめています。
https://zenn.dev/logica0419/articles/gasshuku-isucon-benchmarker
ポータルについてはこちらの記事にまとめています。
https://zenn.dev/logica0419/articles/gasshuku-isucon-portal
主に自分がどのようなことを考えて、どんなスケジュールで進めていったかはこちらの記事にまとめています。
https://zenn.dev/logica0419/articles/gasshuku-isucon-timeline
ご興味あればこれらも是非ご覧下さい。

# 問題概要

今回僕が作った問題は、
**ISULIBRARY**
図書館の会員・蔵書を管理するシステムです。

小さいころに通っていた、近所の図書館のシステムをモチーフにしています。もちろん内部事情を知るわけないのでほとんど想像で補っており、実際のシステムとどこまで似ているかはわかりません。  
1つの図書館で数千人の会員と数万冊の本を所有する、大規模な図書館をイメージしています。

## アプリケーション機能一覧

- 会員管理
  - 会員登録
    - 会員証の発行に必要なQRコードを生成
  - 会員編集
  - 会員一覧
  - 会員情報閲覧
  - 出禁登録 (延滞しすぎた場合)
- 蔵書管理
  - 蔵書登録
    - 蔵書に貼り付けるQRコードを生成
  - 蔵書検索
    - ジャンル・著者・タイトルで検索できる
  - 蔵書情報閲覧
- 貸出管理
  - 貸出
    - 返却期限は5秒間としている
  - 返却
  - 貸出記録一覧
  - 延滞蔵書一覧

その他詳しいことは問題のDocsを見て下さい。

# ボトルネックとそれに対する想定解

自分が試しに解いてみた時に対処した順にボトルネックを紹介していきます。

## QRコードのエンコード

とりあえずここは目についた人も多いのではないでしょうか。

:::details 問題点

初期実装では、qrencodeというCLIアプリケーションを使って書き出しています。
https://github.com/fukuchi/libqrencode
わざわざコマンドを呼んでファイルを書き出している辺り、明らかに遅そうな感じがしますね！

```go
/*
生成するQRコードの仕様
  - PNGフォーマット
  - QRコードの1モジュールは1ピクセルで表現
  - バージョン5 (37x37ピクセル、マージン含め45x45ピクセル)
  - エラー訂正レベルM (15%)
*/
_, err = exec.
  Command("qrencode", "-o", qrCodeFileName, "-t", "PNG", "-s", "1", "-v", "5", "--strict-version", "-l", "M", encryptedID).
  Output()

file, err := os.Open(qrCodeFileName)
if err != nil {
  return nil, err
}
defer file.Close()

return io.ReadAll(file)
```

またQRコード生成には2つ目の罠が仕込まれており、なんとQRコードを生成する関数を呼ぶ度にロックを取っています。
これは、QRコード生成の過程で一回ファイルに書き出してから読みだすということをしているため、この一時ファイルを1つに絞って競合を起こさないためにロックを余儀なくさせるというアイデアです。

:::

:::details 想定解

QRコードをライブラリで生成するのが想定解でした。`qrencode`のコマンド列に様々な設定を付けていたのは、あえて生成の条件を全部固定化することで解きやすくするためです。
自分で試した時は`github.com/skip2/go-qrcode`で生成しましたが、他のライブラリでも設定をミスらなければ問題ないと思います。
https://github.com/skip2/go-qrcode
サンプルはこんな感じ。

```go
qr, err := qrcode.NewWithForcedVersion(encryptedID, 5, qrcode.Medium)
if err != nil {
  return nil, err
}
return qr.PNG(37) // レベル5のQRコードの縦・横幅
```

バージョンとサイズの対応は以下のようなサイトを参考にするといいでしょう。
https://www.qrcode.com/en/about/version.html
ライブラリによってはバイナリを生成するのでなくストリームとして書き込むメソッドも用意されているので、上手く繋いでそのままレスポンスとして返すことができればもっと早くなるかもしれません。

ライブラリを使えば無駄にロックを取ることも無くなるはずです。ここでロックを外せなかった人は、とりあえず試してみる勇気を身につけてほしいところです。

また、今回のシナリオでは複数回エンドポイントが叩かれることは無かったので、キャッシュはほぼ意味を為さなかったと思います。

:::

# こだわりポイント

ボトルネックとして設計しては無いけれど、問題の中で少しこだわりを持って作っていた部分があるので、紹介させてください。

:::details QRコードの中身 (暗号化について)

QRコードはURLを格納するのが一般的ですが、今回はIDの文字列を格納しています。会員証向けも蔵書向けも一緒です。
蔵書はみんなの目に触れるので偽造もへったくれも無いですが、会員証向けは流石に偽造を防ぐ策くらい用意した方がいいと思い、暗号化を施しました。
IDはULIDで振られていくので偽造は難しいかと思いますが、万が一を考えての実装です。

今回の暗号化は、サーバーで発行したQRコードの中身をサーバーで検証するというフローですので、共通鍵方式で問題ないと判断しました。
https://deeeet.com/writing/2015/11/10/go-crypto/
実装の際はこちらの記事に大いに助けられました。
AES + CTRモードで暗号化を施したのち、QRコードにエンコードできる形にするためにBase64でエンコードして文字列にする、という方式で暗号化をしています。

また、initialize時に共通鍵を生成して渡し、それを使わせることで不正なQRコードのキャッシュを防ぐようにしています。キャッシュや出力したファイルを消さないとエラーで大変なことになったのではないでしょうか。

暗号化部分は基本いじらない部分だったと思うので改善ポイントではないのですが、個人的にちょっと頑張ったポイントです。

:::

:::details セッション管理を排除した

ここ2～3年の問題と比べた時、今回の問題でもっとも特筆すべき部分は**Cookie等によるセッション管理が無い**事だと思います。
今回それが可能になった理由は以下の通り。

- 想定しているクライアントが以下しかないので、会員をクライアントごとに識別する必要はない
  - 図書館職員が操作するPC
    - 会員証を読みこみ、リクエストボディでユーザーを伝える
  - 蔵書検索用に用意された図書館内の端末
    - 蔵書検索はユーザー識別をしない
- クライアント - サーバーのネットワークはプライベートネットワーク内に構築されている(という想定)なので、閲覧のセキュリティ的にも縛りが少ない

Go言語においてCookieセッション管理のデファクトスタンダード的存在だった`github.com/gorilla/sessions`がつい最近アーカイブになってしまって大きな話題となったということもあり、セッション管理を外したのは良い選択だったと思います。
https://github.com/gorilla/sessions

:::
